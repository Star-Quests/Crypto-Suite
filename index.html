<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crypto Suite - Institutional Trading Platform</title>
    <script src="https://cdn.jsdelivr.net/npm/decimal.js@10/decimal.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-primary: #0a0b0d;
            --bg-secondary: #111318;
            --bg-card: #15171e;
            --bg-glass: rgba(30, 35, 48, 0.6);
            --border: rgba(255, 255, 255, 0.08);
            --border-light: rgba(255, 255, 255, 0.12);
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --accent: #06b6d4;
            --accent-hover: #22d3ee;
            --success: #10b981;
            --success-light: #34d399;
            --danger: #ef4444;
            --danger-light: #f87171;
            --warning: #f59e0b;
            --warning-light: #fbbf24;
            --gradient-primary: linear-gradient(135deg, #06b6d4 0%, #3b82f6 100%);
            --gradient-card: linear-gradient(180deg, rgba(30, 35, 48, 0.8) 0%, rgba(21, 23, 30, 0.9) 100%);
            --shadow-lg: 0 10px 30px rgba(0, 0, 0, 0.4);
            --shadow-xl: 0 20px 40px rgba(0, 0, 0, 0.5);
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 20px;
            --transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
        }

        body {
            background-color: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
            font-size: 14px;
            line-height: 1.5;
        }

        /* Header */
        header {
            background-color: var(--bg-card);
            border-bottom: 1px solid var(--border);
            padding: 0.75rem 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
            background-color: rgba(21, 23, 30, 0.9);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .menu-toggle {
            background: transparent;
            border: 1px solid var(--border-light);
            color: var(--text-primary);
            width: 40px;
            height: 40px;
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
        }

        .menu-toggle:hover {
            background-color: var(--bg-glass);
            border-color: var(--accent);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            background-color: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.2);
            border-radius: var(--radius-sm);
            font-size: 0.75rem;
            font-weight: 500;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: var(--success);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Sidebar Navigation */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            width: 260px;
            background-color: var(--bg-card);
            border-right: 1px solid var(--border);
            padding: 1.5rem 1rem;
            transform: translateX(-100%);
            transition: var(--transition);
            z-index: 90;
            overflow-y: auto;
        }

        .sidebar.active {
            transform: translateX(0);
            box-shadow: var(--shadow-xl);
        }

        .sidebar-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 80;
            display: none;
            backdrop-filter: blur(2px);
        }

        .sidebar-overlay.active {
            display: block;
        }

        .sidebar-header {
            padding: 0 0.75rem 1.5rem;
            border-bottom: 1px solid var(--border);
            margin-bottom: 1.5rem;
        }

        .sidebar-logo {
            font-weight: 800;
            font-size: 1.5rem;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .sidebar-logo i {
            font-size: 1.25rem;
        }

        .nav-items {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.875rem 1rem;
            border-radius: var(--radius-md);
            color: var(--text-secondary);
            text-decoration: none;
            transition: var(--transition);
            cursor: pointer;
        }

        .nav-item:hover {
            background-color: var(--bg-glass);
            color: var(--text-primary);
        }

        .nav-item.active {
            background: var(--gradient-primary);
            color: white;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(6, 182, 212, 0.2);
        }

        .nav-item i {
            font-size: 1.125rem;
            width: 20px;
            text-align: center;
        }

        /* Main Content */
        .main-content {
            padding: 1.5rem;
            max-width: 1400px;
            margin: 0 auto;
            transition: var(--transition);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .section-subtitle {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
        }

        /* Cards */
        .card {
            background: var(--gradient-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            box-shadow: var(--shadow-lg);
            transition: var(--transition);
            backdrop-filter: blur(10px);
        }

        .card:hover {
            border-color: var(--border-light);
            box-shadow: var(--shadow-xl);
            transform: translateY(-2px);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .card-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .card-title i {
            color: var(--accent);
        }

        .card-value {
            font-size: 1.75rem;
            font-weight: 700;
            margin-top: 0.5rem;
        }

        .card-value.positive {
            color: var(--success);
        }

        .card-value.negative {
            color: var(--danger);
        }

        .card-change {
            font-size: 0.875rem;
            margin-top: 0.25rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .card-change.positive {
            color: var(--success);
        }

        .card-change.negative {
            color: var(--danger);
        }

        /* Dashboard Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        /* Price Ticker */
        .price-ticker {
            display: flex;
            overflow-x: auto;
            background-color: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 1rem;
            margin-bottom: 1.5rem;
            border: 1px solid var(--border);
            gap: 1.5rem;
            scrollbar-width: thin;
            scrollbar-color: var(--accent) transparent;
        }

        .price-ticker::-webkit-scrollbar {
            height: 4px;
        }

        .price-ticker::-webkit-scrollbar-track {
            background: transparent;
        }

        .price-ticker::-webkit-scrollbar-thumb {
            background-color: var(--accent);
            border-radius: 20px;
        }

        .price-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem 0;
            min-width: 160px;
        }

        .crypto-logo {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
            border: 1px solid var(--border);
        }

        .crypto-info {
            flex: 1;
        }

        .crypto-symbol {
            font-weight: 600;
            font-size: 0.875rem;
        }

        .crypto-name {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .price-info {
            text-align: right;
        }

        .current-price {
            font-weight: 600;
            font-size: 0.95rem;
        }

        .price-change {
            font-size: 0.75rem;
            font-weight: 500;
            margin-top: 0.125rem;
        }

        .price-change.positive {
            color: var(--success);
        }

        .price-change.negative {
            color: var(--danger);
        }

        /* Trade Status */
        .trade-status-card {
            background: var(--gradient-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            margin-bottom: 2rem;
            border-left: 4px solid var(--accent);
        }

        .trade-status-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .trade-status-badge {
            padding: 0.375rem 0.75rem;
            background-color: rgba(6, 182, 212, 0.1);
            color: var(--accent);
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.375rem;
        }

        .trade-status-badge.active {
            background-color: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }

        .trade-status-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .status-item {
            padding: 0.75rem;
            background-color: rgba(255, 255, 255, 0.03);
            border-radius: var(--radius-md);
        }

        .status-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 0.25rem;
        }

        .status-value {
            font-size: 1.125rem;
            font-weight: 600;
        }

        /* Holdings Table */
        .table-container {
            overflow-x: auto;
            border-radius: var(--radius-lg);
            border: 1px solid var(--border);
            background-color: var(--bg-card);
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }

        .table th {
            background-color: rgba(255, 255, 255, 0.03);
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border-bottom: 1px solid var(--border);
        }

        .table td {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            font-size: 0.875rem;
        }

        .table tr:last-child td {
            border-bottom: none;
        }

        .table tr:hover {
            background-color: rgba(255, 255, 255, 0.02);
        }

        .table .positive {
            color: var(--success);
        }

        .table .negative {
            color: var(--danger);
        }

        .holding-asset {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        /* Forms and Inputs */
        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            font-size: 0.875rem;
        }

        .form-control {
            width: 100%;
            padding: 0.75rem 1rem;
            background-color: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-size: 0.875rem;
            transition: var(--transition);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(6, 182, 212, 0.1);
        }

        .input-with-button {
            display: flex;
            gap: 0.5rem;
        }

        .input-with-button .form-control {
            flex: 1;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.75rem 1.25rem;
            border-radius: var(--radius-md);
            font-weight: 500;
            font-size: 0.875rem;
            cursor: pointer;
            transition: var(--transition);
            border: none;
            outline: none;
        }

        .btn-primary {
            background: var(--gradient-primary);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(6, 182, 212, 0.3);
        }

        .btn-secondary {
            background-color: rgba(255, 255, 255, 0.05);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background-color: rgba(255, 255, 255, 0.1);
            border-color: var(--border-light);
        }

        .btn-success {
            background-color: var(--success);
            color: white;
        }

        .btn-success:hover {
            background-color: var(--success-light);
            transform: translateY(-2px);
        }

        .btn-danger {
            background-color: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background-color: var(--danger-light);
            transform: translateY(-2px);
        }

        .btn-sm {
            padding: 0.5rem 0.75rem;
            font-size: 0.75rem;
        }

        .btn-full {
            width: 100%;
        }

        /* Trade Planner */
        .trade-planner-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }

        @media (max-width: 1024px) {
            .trade-planner-grid {
                grid-template-columns: 1fr;
            }
        }

        .mode-selector {
            display: flex;
            background-color: rgba(255, 255, 255, 0.03);
            border-radius: var(--radius-md);
            padding: 0.25rem;
            margin-bottom: 1.5rem;
        }

        .mode-btn {
            flex: 1;
            padding: 0.75rem;
            text-align: center;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-weight: 500;
            cursor: pointer;
            border-radius: var(--radius-sm);
            transition: var(--transition);
        }

        .mode-btn:hover {
            color: var(--text-primary);
        }

        .mode-btn.active {
            background-color: var(--bg-card);
            color: var(--text-primary);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        /* Results Panel */
        .results-panel {
            background: var(--gradient-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
        }

        .results-header {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--border);
        }

        .result-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .result-label {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .result-value {
            font-weight: 600;
        }

        /* Journal */
        .transaction-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        /* Settings */
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .toggle-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background-color: rgba(255, 255, 255, 0.03);
            border-radius: var(--radius-md);
            border: 1px solid var(--border);
        }

        .toggle-info h4 {
            font-size: 0.875rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .toggle-info p {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 26px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.1);
            transition: var(--transition);
            border-radius: 34px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: var(--transition);
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: var(--accent);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            max-width: 350px;
        }

        .toast {
            background: var(--gradient-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 1rem 1.25rem;
            box-shadow: var(--shadow-xl);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            transform: translateX(100%);
            opacity: 0;
            transition: var(--transition);
        }

        .toast.show {
            transform: translateX(0);
            opacity: 1;
        }

        .toast.success {
            border-left: 4px solid var(--success);
        }

        .toast.error {
            border-left: 4px solid var(--danger);
        }

        .toast.warning {
            border-left: 4px solid var(--warning);
        }

        .toast.info {
            border-left: 4px solid var(--accent);
        }

        .toast-icon {
            font-size: 1.25rem;
        }

        .toast.success .toast-icon {
            color: var(--success);
        }

        .toast.error .toast-icon {
            color: var(--danger);
        }

        .toast.warning .toast-icon {
            color: var(--warning);
        }

        .toast.info .toast-icon {
            color: var(--accent);
        }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: 600;
            font-size: 0.875rem;
            margin-bottom: 0.125rem;
        }

        .toast-message {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .toast-close {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 1.25rem;
            cursor: pointer;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: var(--transition);
        }

        .toast-close:hover {
            background-color: rgba(255, 255, 255, 0.05);
            color: var(--text-primary);
        }

        /* Asset Management Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1.5rem;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition);
            backdrop-filter: blur(4px);
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: var(--gradient-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-xl);
            transform: scale(0.95);
            transition: var(--transition);
        }

        .modal-overlay.active .modal {
            transform: scale(1);
        }

        .modal-header {
            padding: 1.5rem 1.5rem 0.75rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .modal-close {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: var(--transition);
        }

        .modal-close:hover {
            background-color: rgba(255, 255, 255, 0.05);
            color: var(--text-primary);
        }

        .modal-body {
            padding: 1.5rem;
        }

        .asset-search {
            margin-bottom: 1.5rem;
        }

        .asset-search-input {
            width: 100%;
            padding: 0.75rem 1rem;
            background-color: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-size: 0.875rem;
        }

        .asset-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            max-height: 400px;
            overflow-y: auto;
        }

        .asset-list-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: var(--transition);
        }

        .asset-list-item:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }

        .asset-list-checkbox {
            width: 18px;
            height: 18px;
            border-radius: 4px;
            border: 1px solid var(--border-light);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .asset-list-item.selected .asset-list-checkbox {
            background-color: var(--accent);
            border-color: var(--accent);
        }

        .asset-list-checkbox i {
            font-size: 0.75rem;
            color: white;
        }

        .asset-list-details {
            flex: 1;
        }

        .asset-list-symbol {
            font-weight: 600;
            font-size: 0.875rem;
        }

        .asset-list-name {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        /* Loading States */
        .loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 3rem;
            gap: 1rem;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border-top-color: var(--accent);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .main-content {
                padding: 1rem;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .price-ticker {
                gap: 1rem;
            }
            
            .price-item {
                min-width: 140px;
            }
            
            .trade-status-content {
                grid-template-columns: 1fr;
            }
            
            .form-group {
                margin-bottom: 1rem;
            }
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Cycle Timer */
        .cycle-timer {
            font-family: 'Courier New', monospace;
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--accent);
            background: rgba(6, 182, 212, 0.1);
            padding: 0.25rem 0.75rem;
            border-radius: var(--radius-sm);
            display: inline-block;
        }

        /* P/L Period Selector */
        .pl-period-selector {
            display: flex;
            background-color: rgba(255, 255, 255, 0.03);
            border-radius: var(--radius-md);
            padding: 0.25rem;
            margin-top: 0.5rem;
        }

        .pl-period-btn {
            flex: 1;
            padding: 0.5rem;
            text-align: center;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 0.75rem;
            cursor: pointer;
            border-radius: var(--radius-sm);
            transition: var(--transition);
        }

        .pl-period-btn:hover {
            color: var(--text-primary);
        }

        .pl-period-btn.active {
            background-color: var(--bg-card);
            color: var(--accent);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header>
        <div class="header-left">
            <button class="menu-toggle" id="menuToggle">
                <i class="fas fa-bars"></i>
            </button>
        </div>
        
        <div class="header-right">
            <div class="connection-status" id="connectionStatus">
                <span class="status-indicator"></span>
                <span>Connecting to Bybit...</span>
            </div>
        </div>
    </header>

    <!-- Sidebar Navigation -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>
    <nav class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo">
                <i class="fas fa-chart-line"></i>
                Crypto Suite
            </div>
        </div>
        
        <div class="nav-items">
            <a class="nav-item active" data-section="dashboard">
                <i class="fas fa-tachometer-alt"></i>
                <span>Dashboard</span>
            </a>
            <a class="nav-item" data-section="trade-planner">
                <i class="fas fa-chart-line"></i>
                <span>Trade Planner</span>
            </a>
            <a class="nav-item" data-section="journal">
                <i class="fas fa-book"></i>
                <span>Journal</span>
            </a>
            <a class="nav-item" data-section="settings">
                <i class="fas fa-cog"></i>
                <span>Settings</span>
            </a>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content" id="mainContent">
        <!-- Dashboard Section -->
        <section id="dashboard" class="content-section active">
            <div class="section-header">
                <div>
                    <h1 class="section-title">Dashboard</h1>
                    <p class="section-subtitle">Real-time portfolio overview and market data</p>
                </div>
                <button class="btn btn-primary" id="manageAssetsBtn">
                    <i class="fas fa-coins"></i>
                    Manage Assets
                </button>
            </div>

            <!-- Price Ticker -->
            <div class="price-ticker" id="priceTicker">
                <!-- Price items will be dynamically added here -->
            </div>

            <!-- Trade Status -->
            <div class="trade-status-card">
                <div class="trade-status-header">
                    <h3>Trade Cycle Status</h3>
                    <div class="trade-status-badge" id="tradeStatusBadge">
                        <i class="fas fa-circle"></i>
                        <span>No Active Trade</span>
                    </div>
                </div>
                <div class="trade-status-content">
                    <div class="status-item">
                        <div class="status-label">Current Cycle Duration</div>
                        <div class="status-value">
                            <span class="cycle-timer" id="tradeDuration">00:00:00</span>
                        </div>
                    </div>
                    <div class="status-item">
                        <div class="status-label">Cycle Realized P/L</div>
                        <div class="status-value" id="cycleRealizedPL">$0.00</div>
                    </div>
                    <div class="status-item">
                        <div class="status-label">Cycle Transactions</div>
                        <div class="status-value" id="cycleTransactions">0</div>
                    </div>
                    <div class="status-item">
                        <div class="status-label">Cycle Fees</div>
                        <div class="status-value" id="cycleFees">$0.00</div>
                    </div>
                </div>
                <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                    <button class="btn btn-success" id="startTradeBtn">
                        <i class="fas fa-play"></i>
                        Start New Trade
                    </button>
                    <button class="btn btn-secondary" id="completeTradeBtn" style="display: none;">
                        <i class="fas fa-flag-checkered"></i>
                        Complete Trade
                    </button>
                </div>
            </div>

            <!-- Portfolio Metrics -->
            <div class="dashboard-grid">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-wallet"></i>
                            Total Portfolio Value
                        </div>
                        <i class="fas fa-sync-alt" style="color: var(--accent); cursor: pointer;" id="refreshPortfolio"></i>
                    </div>
                    <div class="card-value" id="portfolioValue">$0.00</div>
                    <div class="card-change" id="portfolioChange">
                        <i class="fas fa-arrow-up"></i>
                        <span>0.00% Today</span>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-chart-bar"></i>
                            Realized P/L
                        </div>
                    </div>
                    <div class="card-value" id="realizedPL">$0.00</div>
                    <div class="card-change" id="realizedPLChange">
                        <i class="fas fa-arrow-up"></i>
                        <span>0.00%</span>
                    </div>
                    <div class="pl-period-selector">
                        <button class="pl-period-btn active" data-pl-period="all">All</button>
                        <button class="pl-period-btn" data-pl-period="month">Month</button>
                        <button class="pl-period-btn" data-pl-period="cycle">Cycle</button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-money-bill-wave"></i>
                            Current Trade Capital
                        </div>
                    </div>
                    <div class="card-value" id="currentTradeCapital">$0.00</div>
                    <div class="card-change" id="capitalChange">No active trade</div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-receipt"></i>
                            Total Fees
                        </div>
                    </div>
                    <div class="card-value" id="totalFees">$0.00</div>
                    <div class="card-change" id="feesChange">All time</div>
                </div>
            </div>

            <!-- Current Holdings -->
            <div style="margin-top: 2rem;">
                <div class="section-header">
                    <h2 class="section-title">Current Holdings</h2>
                    <button class="btn btn-secondary" id="refreshHoldings">
                        <i class="fas fa-sync-alt"></i>
                        Refresh
                    </button>
                </div>
                <div class="table-container">
                    <table class="table" id="holdingsTable">
                        <thead>
                            <tr>
                                <th>Asset</th>
                                <th>Amount</th>
                                <th>Avg. Price</th>
                                <th>Current Price</th>
                                <th>Current Value</th>
                                <th>Unrealized P/L</th>
                                <th>P/L %</th>
                            </tr>
                        </thead>
                        <tbody id="holdingsTableBody">
                            <tr>
                                <td colspan="7" style="text-align: center; padding: 3rem; color: var(--text-muted);">
                                    No holdings yet. Add transactions to see your portfolio.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Trade Cycles -->
            <div style="margin-top: 2rem;">
                <div class="section-header">
                    <h2 class="section-title">Recent Trade Cycles</h2>
                </div>
                <div class="table-container">
                    <table class="table" id="tradeCyclesTable">
                        <thead>
                            <tr>
                                <th>Start Date</th>
                                <th>End Date</th>
                                <th>Capital</th>
                                <th>Realized P/L</th>
                                <th>P/L %</th>
                                <th>Fees</th>
                                <th>Transactions</th>
                            </tr>
                        </thead>
                        <tbody id="tradeCyclesTableBody">
                            <tr>
                                <td colspan="7" style="text-align: center; padding: 3rem; color: var(--text-muted);">
                                    No completed trade cycles yet.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Trade Planner Section -->
        <section id="trade-planner" class="content-section" style="display: none;">
            <div class="section-header">
                <div>
                    <h1 class="section-title">Trade Planner</h1>
                    <p class="section-subtitle">Calculate profit targets, stop losses, and risk management</p>
                </div>
            </div>

            <div class="trade-planner-grid">
                <div class="card">
                    <div class="mode-selector">
                        <button class="mode-btn active" data-mode="tp-sl">
                            <i class="fas fa-bullseye"></i>
                            TP/SL Mode
                        </button>
                        <button class="mode-btn" data-mode="trailing">
                            <i class="fas fa-arrow-trend-down"></i>
                            Trailing Stop
                        </button>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Select Asset</label>
                        <select class="form-control" id="plannerAsset">
                            <!-- Assets will be populated dynamically -->
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Entry Price ($)</label>
                        <div class="input-with-button">
                            <input type="number" class="form-control" id="entryPrice" step="0.000001" placeholder="e.g. 50000">
                            <button class="btn btn-secondary" id="currentPriceBtn">
                                <i class="fas fa-bolt"></i>
                                Current Price
                            </button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Amount (Asset Units)</label>
                        <input type="number" class="form-control" id="amount" step="0.000001" placeholder="e.g. 0.5">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Target Profit ($)</label>
                        <input type="number" class="form-control" id="targetProfit" step="0.000001" placeholder="e.g. 1000">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Maximum Capital Loss ($)</label>
                        <input type="number" class="form-control" id="maxCapitalLoss" step="0.000001" placeholder="e.g. 500" value="100">
                    </div>

                    <div class="form-group" id="trailingInput" style="display: none;">
                        <label class="form-label">Trailing Stop Distance ($)</label>
                        <input type="number" class="form-control" id="trailingDistance" step="0.000001" placeholder="e.g. 200">
                    </div>

                    <button class="btn btn-primary btn-full" id="calculateTradeBtn">
                        <i class="fas fa-calculator"></i>
                        Calculate Trade
                    </button>
                </div>

                <div class="results-panel">
                    <div class="results-header" id="resultsHeader">TP/SL Results</div>
                    
                    <div id="tpSlResults">
                        <div class="result-row">
                            <span class="result-label">Total Capital:</span>
                            <span class="result-value" id="capitalValue">$0.00</span>
                        </div>
                        
                        <div class="result-row">
                            <span class="result-label">Take Profit Price:</span>
                            <span class="result-value" id="tpPrice">$0.00</span>
                        </div>
                        
                        <div class="result-row">
                            <span class="result-label">Stop Loss Price:</span>
                            <span class="result-value" id="slPrice">$0.00</span>
                        </div>
                        
                        <div style="height: 1px; background-color: var(--border); margin: 1.5rem 0;"></div>
                        
                        <div class="result-row">
                            <span class="result-label">Potential Profit:</span>
                            <span class="result-value positive" id="potentialProfit">+$0.00</span>
                        </div>
                        
                        <div class="result-row">
                            <span class="result-label">Potential Loss:</span>
                            <span class="result-value negative" id="potentialLoss">-$0.00</span>
                        </div>
                        
                        <div class="result-row">
                            <span class="result-label">Capital if SL Hits:</span>
                            <span class="result-value" id="capitalIfSL">$0.00</span>
                        </div>
                        
                        <div style="height: 1px; background-color: var(--border); margin: 1.5rem 0;"></div>
                        
                        <div class="result-row">
                            <span class="result-label">ROI:</span>
                            <span class="result-value" id="roiValue">0%</span>
                        </div>
                        
                        <div class="result-row">
                            <span class="result-label">Risk/Reward Ratio:</span>
                            <span class="result-value" id="rrRatio">1:0</span>
                        </div>
                    </div>

                    <div id="trailingResults" style="display: none;">
                        <div class="result-row">
                            <span class="result-label">Total Capital:</span>
                            <span class="result-value" id="trailingCapital">$0.00</span>
                        </div>
                        
                        <div class="result-row">
                            <span class="result-label">Take Profit Price:</span>
                            <span class="result-value" id="trailingTP">$0.00</span>
                        </div>
                        
                        <div class="result-row">
                            <span class="result-label">Stop Loss Price:</span>
                            <span class="result-value" id="trailingSL">$0.00</span>
                        </div>
                        
                        <div class="result-row">
                            <span class="result-label">Activation Price:</span>
                            <span class="result-value" id="activationPrice">$0.00</span>
                        </div>
                        
                        <div class="result-row">
                            <span class="result-label">Trailing Stop Price:</span>
                            <span class="result-value" id="trailingStopPrice">$0.00</span>
                        </div>
                        
                        <div style="height: 1px; background-color: var(--border); margin: 1.5rem 0;"></div>
                        
                        <div class="result-row">
                            <span class="result-label">Potential Profit:</span>
                            <span class="result-value positive" id="trailingProfit">+$0.00</span>
                        </div>
                        
                        <div class="result-row">
                            <span class="result-label">Potential Loss:</span>
                            <span class="result-value negative" id="trailingLoss">-$0.00</span>
                        </div>
                        
                        <div class="result-row">
                            <span class="result-label">Capital if SL Hits:</span>
                            <span class="result-value" id="trailingCapitalSL">$0.00</span>
                        </div>
                        
                        <div class="result-row">
                            <span class="result-label">Secured Profit:</span>
                            <span class="result-value positive" id="securedProfit">+$0.00</span>
                        </div>
                        
                        <div style="height: 1px; background-color: var(--border); margin: 1.5rem 0;"></div>
                        
                        <div class="result-row">
                            <span class="result-label">ROI:</span>
                            <span class="result-value" id="trailingROI">0%</span>
                        </div>
                        
                        <div class="result-row">
                            <span class="result-label">Risk/Reward Ratio:</span>
                            <span class="result-value" id="trailingRR">1:0</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Journal Section -->
        <section id="journal" class="content-section" style="display: none;">
            <div class="section-header">
                <div>
                    <h1 class="section-title">Trade Journal</h1>
                    <p class="section-subtitle">Track and analyze all your trading transactions</p>
                </div>
                <button class="btn btn-primary" id="addTransactionBtn">
                    <i class="fas fa-plus"></i>
                    Add Transaction
                </button>
            </div>

            <div class="card" style="margin-bottom: 2rem;">
                <div class="transaction-form" id="transactionForm" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">Transaction Type</label>
                        <select class="form-control" id="txType">
                            <option value="BUY">BUY</option>
                            <option value="SELL">SELL</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Asset</label>
                        <select class="form-control" id="txAsset">
                            <!-- Assets will be populated dynamically -->
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Amount</label>
                        <input type="number" class="form-control" id="txAmount" placeholder="Amount" step="0.000001">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Price per unit ($)</label>
                        <input type="number" class="form-control" id="txPrice" placeholder="Price per unit ($)" step="0.000001">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Fee</label>
                        <input type="number" class="form-control" id="txFee" placeholder="Fee" step="0.000001" value="0">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Fee Currency</label>
                        <select class="form-control" id="txFeeCurrency">
                            <option value="USDT">USDT</option>
                            <!-- Other currencies will be populated dynamically -->
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Date & Time</label>
                        <input type="datetime-local" class="form-control" id="txDate">
                    </div>

                    <div class="form-group" style="grid-column: 1 / -1; display: flex; gap: 1rem;">
                        <button class="btn btn-success" id="saveTransactionBtn">
                            <i class="fas fa-save"></i>
                            Save Transaction
                        </button>
                        <button class="btn btn-secondary" id="cancelTransactionBtn">
                            <i class="fas fa-times"></i>
                            Cancel
                        </button>
                    </div>
                </div>

                <div style="text-align: center; padding: 2rem;" id="noFormMessage">
                    <button class="btn btn-primary" id="showTransactionFormBtn">
                        <i class="fas fa-plus"></i>
                        Add New Transaction
                    </button>
                </div>
            </div>

            <div class="table-container">
                <table class="table" id="transactionsTable">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Type</th>
                            <th>Asset</th>
                            <th>Amount</th>
                            <th>Price</th>
                            <th>Value</th>
                            <th>Fee</th>
                            <th>P/L</th>
                            <th>Trade Cycle</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="transactionsTableBody">
                        <tr>
                            <td colspan="10" style="text-align: center; padding: 3rem; color: var(--text-muted);">
                                No transactions yet. Add your first transaction to begin tracking.
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div style="display: flex; gap: 1rem; margin-top: 1.5rem; flex-wrap: wrap;">
                <button class="btn btn-secondary" id="exportCsvBtn">
                    <i class="fas fa-file-csv"></i>
                    Export CSV
                </button>
                <button class="btn btn-secondary" id="exportJsonBtn">
                    <i class="fas fa-file-code"></i>
                    Export JSON
                </button>
                <button class="btn btn-secondary" id="importBtn">
                    <i class="fas fa-file-import"></i>
                    Import Data
                </button>
                <button class="btn btn-danger" id="resetDataBtn">
                    <i class="fas fa-trash"></i>
                    Reset All Data
                </button>
                <input type="file" id="importFileInput" accept=".json" style="display: none;">
            </div>
        </section>

        <!-- Settings Section -->
        <section id="settings" class="content-section" style="display: none;">
            <div class="section-header">
                <div>
                    <h1 class="section-title">Settings</h1>
                    <p class="section-subtitle">Configure your trading platform preferences</p>
                </div>
            </div>

            <div class="settings-grid">
                <div class="card">
                    <h3 style="margin-bottom: 1.5rem;">Display Settings</h3>
                    
                    <div class="toggle-item">
                        <div class="toggle-info">
                            <h4>Tablet Mode</h4>
                            <p>Optimize layout for tablet devices</p>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="tabletModeToggle">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>

                    <div class="toggle-item">
                        <div class="toggle-info">
                            <h4>Auto-refresh Prices</h4>
                            <p>Automatically refresh market prices every 3 seconds</p>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="autoRefreshToggle" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>

                    <div class="toggle-item">
                        <div class="toggle-info">
                            <h4>Show Notifications</h4>
                            <p>Display toast notifications for important events</p>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="notificationsToggle" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>

                <div class="card">
                    <h3 style="margin-bottom: 1.5rem;">Data Management</h3>
                    
                    <div style="display: flex; flex-direction: column; gap: 1rem;">
                        <button class="btn btn-primary" id="backupDataBtn">
                            <i class="fas fa-download"></i>
                            Backup All Data
                        </button>
                        
                        <button class="btn btn-secondary" id="clearCacheBtn">
                            <i class="fas fa-broom"></i>
                            Clear Application Cache
                        </button>
                        
                        <button class="btn btn-danger" id="clearAllDataBtn">
                            <i class="fas fa-trash-alt"></i>
                            Clear All Data
                        </button>
                        
                        <div class="form-group">
                            <label class="form-label">Bybit API Key (Optional - for future features)</label>
                            <input type="password" class="form-control" id="apiKeyInput" placeholder="Enter your API key">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">API Secret (Optional)</label>
                            <input type="password" class="form-control" id="apiSecretInput" placeholder="Enter your API secret">
                        </div>
                        
                        <button class="btn btn-success" id="saveApiCredentialsBtn">
                            <i class="fas fa-save"></i>
                            Save API Credentials
                        </button>
                    </div>
                </div>

                <div class="card">
                    <h3 style="margin-bottom: 1.5rem;">Application Info</h3>
                    
                    <div style="display: flex; flex-direction: column; gap: 1rem;">
                        <div class="status-item">
                            <div class="status-label">Application Version</div>
                            <div class="status-value">2.0.0</div>
                        </div>
                        
                        <div class="status-item">
                            <div class="status-label">Data Last Updated</div>
                            <div class="status-value" id="dataLastUpdated">-</div>
                        </div>
                        
                        <div class="status-item">
                            <div class="status-label">Total Transactions</div>
                            <div class="status-value" id="totalTransactionsCount">0</div>
                        </div>
                        
                        <div class="status-item">
                            <div class="status-label">Trade Cycles</div>
                            <div class="status-value" id="totalTradeCyclesCount">0</div>
                        </div>
                        
                        <div class="status-item">
                            <div class="status-label">Assets Tracked</div>
                            <div class="status-value" id="assetsTrackedCount">0</div>
                        </div>
                        
                        <div class="status-item">
                            <div class="status-label">Storage Used</div>
                            <div class="status-value" id="storageUsed">0 KB</div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Toast Notifications Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Asset Management Modal -->
    <div class="modal-overlay" id="assetManagementModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Manage Assets</h3>
                <button class="modal-close" id="closeAssetModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="asset-search">
                    <input type="text" class="asset-search-input" id="assetSearchInput" placeholder="Search assets...">
                </div>
                
                <div class="asset-list" id="assetList">
                    <!-- Asset list will be populated dynamically -->
                </div>
                
                <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                    <button class="btn btn-primary" id="saveAssetsBtn">
                        <i class="fas fa-save"></i>
                        Save Selection
                    </button>
                    <button class="btn btn-secondary" id="selectAllAssetsBtn">
                        <i class="fas fa-check-square"></i>
                        Select All
                    </button>
                    <button class="btn btn-secondary" id="deselectAllAssetsBtn">
                        <i class="fas fa-square"></i>
                        Deselect All
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==============================
        // CONSTANTS & CONFIGURATION
        // ==============================
        const STORAGE_KEY = 'crypto_suite_final_v1';
        const ASSETS_STORAGE_KEY = 'crypto_suite_selected_assets_v1';
        const BYBIT_WS_URL = 'wss://stream.bybit.com/v5/public/spot';
        
        //  FIXED: Static asset list with guaranteed logos from CoinGecko CDN
        const BYBIT_ASSETS = {
            'BTC': { name: 'Bitcoin', pair: 'BTCUSDT', logo: 'https://assets.coingecko.com/coins/images/1/large/bitcoin.png' },
            'ETH': { name: 'Ethereum', pair: 'ETHUSDT', logo: 'https://assets.coingecko.com/coins/images/279/large/ethereum.png' },
            'SOL': { name: 'Solana', pair: 'SOLUSDT', logo: 'https://assets.coingecko.com/coins/images/4128/large/solana.png' },
            'BNB': { name: 'Binance Coin', pair: 'BNBUSDT', logo: 'https://assets.coingecko.com/coins/images/825/large/bnb-icon2.png' },
            'XRP': { name: 'Ripple', pair: 'XRPUSDT', logo: 'https://assets.coingecko.com/coins/images/44/large/xrp.png' },
            'ADA': { name: 'Cardano', pair: 'ADAUSDT', logo: 'https://assets.coingecko.com/coins/images/975/large/cardano.png' },
            'AVAX': { name: 'Avalanche', pair: 'AVAXUSDT', logo: 'https://assets.coingecko.com/coins/images/12559/large/avax.png' },
            'DOGE': { name: 'Dogecoin', pair: 'DOGEUSDT', logo: 'https://assets.coingecko.com/coins/images/5/large/dogecoin.png' },
            'DOT': { name: 'Polkadot', pair: 'DOTUSDT', logo: 'https://assets.coingecko.com/coins/images/12171/large/polkadot.png' },
            'MATIC': { name: 'Polygon', pair: 'MATICUSDT', logo: 'https://assets.coingecko.com/coins/images/4713/large/polygon.png' },
            'LINK': { name: 'Chainlink', pair: 'LINKUSDT', logo: 'https://assets.coingecko.com/coins/images/877/large/chainlink-new-logo.png' },
            'TRX': { name: 'TRON', pair: 'TRXUSDT', logo: 'https://assets.coingecko.com/coins/images/1094/large/tron-logo.png' },
            'UNI': { name: 'Uniswap', pair: 'UNIUSDT', logo: 'https://assets.coingecko.com/coins/images/12504/large/uniswap.png' },
            'ATOM': { name: 'Cosmos', pair: 'ATOMUSDT', logo: 'https://assets.coingecko.com/coins/images/1481/large/cosmos_hub.png' },
            'LTC': { name: 'Litecoin', pair: 'LTCUSDT', logo: 'https://assets.coingecko.com/coins/images/2/large/litecoin.png' },
            'ETC': { name: 'Ethereum Classic', pair: 'ETCUSDT', logo: 'https://assets.coingecko.com/coins/images/453/large/ethereum-classic.png' },
            'XLM': { name: 'Stellar', pair: 'XLMUSDT', logo: 'https://assets.coingecko.com/coins/images/100/large/Stellar_symbol_black_RGB.png' },
            'ALGO': { name: 'Algorand', pair: 'ALGOUSDT', logo: 'https://assets.coingecko.com/coins/images/4380/large/download.png' },
            'VET': { name: 'VeChain', pair: 'VETUSDT', logo: 'https://assets.coingecko.com/coins/images/1167/large/VET_Token_Icon.png' },
            'FIL': { name: 'Filecoin', pair: 'FILUSDT', logo: 'https://assets.coingecko.com/coins/images/12817/large/filecoin.png' }
        };

        // ==============================
        // STATE MANAGEMENT
        // ==============================
        let state = {
            store: {
                transactions: [],
                settings: {
                    tabletMode: false,
                    autoRefresh: true,
                    notifications: true,
                    selectedAssets: ['BTC', 'ETH', 'SOL'],
                    apiKey: '',
                    apiSecret: ''
                },
                tradeCycles: [],
                currentTrade: {
                    originalCapital: D(0),
                    startTime: null,
                    transactions: [],
                    isActive: false,
                    cycleRealizedPL: D(0)
                },
                lastUpdateTime: null
            },
            priceData: {},
            websocket: null,
            toastCounter: 0,
            selectedAssets: ['BTC', 'ETH', 'SOL'],
            cycleTimerInterval: null,
            autoRefreshInterval: null
        };

        // ==============================
        // UTILITY FUNCTIONS
        // ==============================
        function D(v) {
            try {
                if (v instanceof Decimal) return v;
                return new Decimal(v || 0);
            } catch (e) {
                console.error("Decimal conversion error:", e, "value:", v);
                return new Decimal(0);
            }
        }

        function formatNumber(value, decimals = 8) {
            const num = typeof value === 'string' ? parseFloat(value) : value;
            if (isNaN(num)) return '0';
            
            return new Intl.NumberFormat('en-US', {
                minimumFractionDigits: 0,
                maximumFractionDigits: decimals
            }).format(num);
        }

        function formatCurrency(value, decimals = 2) {
            return `$${formatNumber(value, decimals)}`;
        }

        function formatPercent(value, decimals = 2) {
            const num = typeof value === 'string' ? parseFloat(value) : value;
            if (isNaN(num)) return '0.00%';
            
            const sign = num >= 0 ? '+' : '';
            return `${sign}${formatNumber(num, decimals)}%`;
        }

        function generateId(prefix = 'id') {
            return `${prefix}_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        }

        function formatTime(ms) {
            const totalSeconds = Math.floor(ms / 1000);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        // ==============================
        // TOAST NOTIFICATIONS
        // ==============================
        function showToast(title, message, type = 'info', duration = 5000) {
            if (!state.store.settings.notifications) return;
            
            const toastContainer = document.getElementById('toastContainer');
            const toastId = `toast_${Date.now()}_${state.toastCounter++}`;
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.id = toastId;
            
            let icon = 'info-circle';
            if (type === 'success') icon = 'check-circle';
            if (type === 'error') icon = 'exclamation-circle';
            if (type === 'warning') icon = 'exclamation-triangle';
            
            toast.innerHTML = `
                <i class="fas fa-${icon} toast-icon"></i>
                <div class="toast-content">
                    <div class="toast-title">${title}</div>
                    <div class="toast-message">${message}</div>
                </div>
                <button class="toast-close" onclick="removeToast('${toastId}')">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            toastContainer.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.add('show');
            }, 10);
            
            if (duration > 0) {
                setTimeout(() => {
                    removeToast(toastId);
                }, duration);
            }
        }

        function removeToast(toastId) {
            const toast = document.getElementById(toastId);
            if (toast) {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }
        }

        // ==============================
        // STORAGE MANAGEMENT
        // ==============================
        function saveStore() {
            try {
                const storeToSave = {
                    ...state.store,
                    transactions: state.store.transactions.map(tx => ({
                        ...tx,
                        amount: tx.amount.toString(),
                        price: tx.price.toString(),
                        orderValue: tx.orderValue.toString(),
                        fee: tx.fee.toString(),
                        feeInUSDT: tx.feeInUSDT.toString(),
                        profitLoss: tx.profitLoss.toString()
                    })),
                    tradeCycles: state.store.tradeCycles.map(cycle => ({
                        ...cycle,
                        originalCapital: cycle.originalCapital.toString(),
                        realizedPL: cycle.realizedPL.toString(),
                        totalFees: cycle.totalFees.toString(),
                        startTime: cycle.startTime,
                        endTime: cycle.endTime
                    })),
                    currentTrade: {
                        ...state.store.currentTrade,
                        originalCapital: state.store.currentTrade.originalCapital.toString(),
                        cycleRealizedPL: state.store.currentTrade.cycleRealizedPL.toString(),
                        transactions: state.store.currentTrade.transactions,
                        startTime: state.store.currentTrade.startTime,
                        isActive: state.store.currentTrade.isActive
                    },
                    lastUpdateTime: new Date().toISOString()
                };
                
                localStorage.setItem(STORAGE_KEY, JSON.stringify(storeToSave));
                localStorage.setItem(ASSETS_STORAGE_KEY, JSON.stringify(state.store.settings.selectedAssets));
                
                updateStorageInfo();
                updateLastUpdatedTime();
                
            } catch (error) {
                console.error('Error saving store:', error);
                showToast('Error', 'Failed to save data', 'error');
            }
        }

        function loadStore() {
            try {
                const savedStore = localStorage.getItem(STORAGE_KEY);
                const savedAssets = localStorage.getItem(ASSETS_STORAGE_KEY);
                
                if (savedStore) {
                    const parsed = JSON.parse(savedStore);
                    
                    parsed.transactions = parsed.transactions.map(tx => ({
                        ...tx,
                        amount: D(tx.amount),
                        price: D(tx.price),
                        orderValue: D(tx.orderValue),
                        fee: D(tx.fee),
                        feeInUSDT: D(tx.feeInUSDT || 0),
                        profitLoss: D(tx.profitLoss || 0)
                    }));
                    
                    if (parsed.tradeCycles) {
                        parsed.tradeCycles = parsed.tradeCycles.map(cycle => ({
                            ...cycle,
                            originalCapital: D(cycle.originalCapital),
                            realizedPL: D(cycle.realizedPL),
                            totalFees: D(cycle.totalFees),
                            startTime: cycle.startTime,
                            endTime: cycle.endTime
                        }));
                    } else {
                        parsed.tradeCycles = [];
                    }
                    
                    if (parsed.currentTrade) {
                        parsed.currentTrade = {
                            ...parsed.currentTrade,
                            originalCapital: D(parsed.currentTrade.originalCapital || 0),
                            cycleRealizedPL: D(parsed.currentTrade.cycleRealizedPL || 0),
                            transactions: parsed.currentTrade.transactions || [],
                            startTime: parsed.currentTrade.startTime,
                            isActive: parsed.currentTrade.isActive || false
                        };
                    } else {
                        parsed.currentTrade = {
                            originalCapital: D(0),
                            cycleRealizedPL: D(0),
                            startTime: null,
                            transactions: [],
                            isActive: false
                        };
                    }
                    
                    if (!parsed.settings) {
                        parsed.settings = {
                            tabletMode: false,
                            autoRefresh: true,
                            notifications: true,
                            selectedAssets: ['BTC', 'ETH', 'SOL'],
                            apiKey: '',
                            apiSecret: ''
                        };
                    }
                    
                    state.store = parsed;
                }
                
                if (savedAssets) {
                    try {
                        const parsedAssets = JSON.parse(savedAssets);
                        state.store.settings.selectedAssets = Array.isArray(parsedAssets) ? parsedAssets : ['BTC', 'ETH', 'SOL'];
                        state.selectedAssets = state.store.settings.selectedAssets;
                    } catch (e) {
                        state.store.settings.selectedAssets = ['BTC', 'ETH', 'SOL'];
                        state.selectedAssets = ['BTC', 'ETH', 'SOL'];
                    }
                }
                
                updateLastUpdatedTime();
                
            } catch (error) {
                console.error('Error loading store:', error);
                showToast('Error', 'Failed to load saved data', 'error');
            }
        }

        function updateStorageInfo() {
            try {
                const totalTransactions = state.store.transactions.length;
                const totalCycles = state.store.tradeCycles.length;
                const assetsTracked = state.selectedAssets.length;
                
                document.getElementById('totalTransactionsCount').textContent = totalTransactions;
                document.getElementById('totalTradeCyclesCount').textContent = totalCycles;
                document.getElementById('assetsTrackedCount').textContent = assetsTracked;
                
                const storageData = JSON.stringify(state.store);
                const sizeInKB = (storageData.length / 1024).toFixed(2);
                document.getElementById('storageUsed').textContent = `${sizeInKB} KB`;
                
            } catch (error) {
                console.error('Error updating storage info:', error);
            }
        }

        function updateLastUpdatedTime() {
            const now = new Date();
            document.getElementById('dataLastUpdated').textContent = now.toLocaleTimeString();
        }

        //  FIXED: Clear All Data Function
        function clearAllData() {
            if (confirm('Are you sure you want to clear ALL data? This cannot be undone.')) {
                localStorage.clear();
                state.store = {
                    transactions: [],
                    settings: {
                        tabletMode: false,
                        autoRefresh: true,
                        notifications: true,
                        selectedAssets: ['BTC', 'ETH', 'SOL'],
                        apiKey: '',
                        apiSecret: ''
                    },
                    tradeCycles: [],
                    currentTrade: {
                        originalCapital: D(0),
                        startTime: null,
                        transactions: [],
                        isActive: false,
                        cycleRealizedPL: D(0)
                    },
                    lastUpdateTime: null
                };
                state.selectedAssets = ['BTC', 'ETH', 'SOL'];
                state.priceData = {};
                
                saveStore();
                renderTransactions();
                calculatePortfolio();
                updateTradeStatus();
                updateTradeCyclesTable();
                updateAssetSelects();
                
                showToast('Data Cleared', 'All data has been reset', 'success');
            }
        }

        //  FIXED: Clear Cache Function
        function clearCache() {
            const keysToKeep = [STORAGE_KEY, ASSETS_STORAGE_KEY];
            const keysToRemove = [];
            
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (!keysToKeep.includes(key)) {
                    keysToRemove.push(key);
                }
            }
            
            keysToRemove.forEach(key => localStorage.removeItem(key));
            showToast('Cache Cleared', `Cleared ${keysToRemove.length} cache items`, 'success');
        }

        // ==============================
        // ASSET MANAGEMENT
        // ==============================
        function loadAssetManagement() {
            const assetList = document.getElementById('assetList');
            const searchInput = document.getElementById('assetSearchInput');
            const selectedAssets = [...state.selectedAssets];
            
            function renderAssets(filter = '') {
                assetList.innerHTML = '';
                
                Object.entries(BYBIT_ASSETS)
                    .filter(([symbol, asset]) => 
                        symbol.toLowerCase().includes(filter.toLowerCase()) || 
                        asset.name.toLowerCase().includes(filter.toLowerCase())
                    )
                    .forEach(([symbol, asset]) => {
                        const isSelected = selectedAssets.includes(symbol);
                        const item = document.createElement('div');
                        item.className = `asset-list-item ${isSelected ? 'selected' : ''}`;
                        item.dataset.symbol = symbol;
                        
                        item.innerHTML = `
                            <div class="asset-list-checkbox">
                                <i class="fas fa-check"></i>
                            </div>
                            <img src="${asset.logo}" alt="${asset.name}" class="crypto-logo">
                            <div class="asset-list-details">
                                <div class="asset-list-symbol">${symbol}</div>
                                <div class="asset-list-name">${asset.name}</div>
                            </div>
                        `;
                        
                        item.addEventListener('click', () => {
                            const index = selectedAssets.indexOf(symbol);
                            if (index === -1) {
                                selectedAssets.push(symbol);
                                item.classList.add('selected');
                            } else {
                                selectedAssets.splice(index, 1);
                                item.classList.remove('selected');
                            }
                        });
                        
                        assetList.appendChild(item);
                    });
                
                if (assetList.children.length === 0) {
                    assetList.innerHTML = `
                        <div style="text-align: center; padding: 2rem; color: var(--text-muted);">
                            No assets found matching "${filter}"
                        </div>
                    `;
                }
            }
            
            renderAssets();
            
            searchInput.addEventListener('input', (e) => {
                renderAssets(e.target.value);
            });
            
            document.getElementById('selectAllAssetsBtn').addEventListener('click', () => {
                selectedAssets.length = 0;
                Object.keys(BYBIT_ASSETS).forEach(symbol => {
                    selectedAssets.push(symbol);
                });
                renderAssets(searchInput.value);
            });
            
            document.getElementById('deselectAllAssetsBtn').addEventListener('click', () => {
                selectedAssets.length = 0;
                renderAssets(searchInput.value);
            });
            
            document.getElementById('saveAssetsBtn').addEventListener('click', () => {
                if (selectedAssets.length === 0) {
                    showToast('Error', 'Please select at least one asset', 'error');
                    return;
                }
                
                state.store.settings.selectedAssets = selectedAssets;
                state.selectedAssets = selectedAssets;
                saveStore();
                updatePriceTicker();
                updateAssetSelects();
                connectWebSocket();
                closeAssetManagementModal();
                showToast('Success', `${selectedAssets.length} assets selected`, 'success');
            });
        }

        function updateAssetSelects() {
            const plannerAssetSelect = document.getElementById('plannerAsset');
            plannerAssetSelect.innerHTML = '';
            
            state.selectedAssets.forEach(symbol => {
                if (BYBIT_ASSETS[symbol]) {
                    const option = document.createElement('option');
                    option.value = symbol;
                    option.textContent = `${symbol} - ${BYBIT_ASSETS[symbol].name}`;
                    plannerAssetSelect.appendChild(option);
                }
            });
            
            const journalAssetSelect = document.getElementById('txAsset');
            journalAssetSelect.innerHTML = '';
            
            state.selectedAssets.forEach(symbol => {
                const option = document.createElement('option');
                option.value = symbol;
                option.textContent = symbol;
                journalAssetSelect.appendChild(option);
            });
            
            const feeCurrencySelect = document.getElementById('txFeeCurrency');
            feeCurrencySelect.innerHTML = '<option value="USDT">USDT</option>';
            
            state.selectedAssets.forEach(symbol => {
                if (symbol !== 'USDT') {
                    const option = document.createElement('option');
                    option.value = symbol;
                    option.textContent = symbol;
                    feeCurrencySelect.appendChild(option);
                }
            });
        }

        // ==============================
        //  FIXED: REAL-TIME BYBIT CONNECTION
        // ==============================
        function connectWebSocket() {
            try {
                if (state.websocket) {
                    state.websocket.close();
                }
                
                state.websocket = new WebSocket(BYBIT_WS_URL);
                
                state.websocket.onopen = () => {
                    console.log('Connected to Bybit WebSocket');
                    document.getElementById('connectionStatus').innerHTML = `
                        <span class="status-indicator"></span>
                        <span>Live: ${state.selectedAssets.length} assets</span>
                    `;
                    
                    const subscribeMessage = {
                        op: 'subscribe',
                        args: state.selectedAssets.map(symbol => 
                            `tickers.${BYBIT_ASSETS[symbol].pair}`
                        )
                    };
                    
                    state.websocket.send(JSON.stringify(subscribeMessage));
                    showToast('Connected', 'Live prices from Bybit', 'success');
                };
                
                state.websocket.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        
                        if (data.topic && data.topic.startsWith('tickers.')) {
                            const symbol = data.topic.replace('tickers.', '');
                            const ticker = data.data;
                            
                            for (const [assetSymbol, assetInfo] of Object.entries(BYBIT_ASSETS)) {
                                if (assetInfo.pair === symbol) {
                                    state.priceData[assetSymbol] = {
                                        price: parseFloat(ticker.lastPrice),
                                        change24h: parseFloat(ticker.price24hPcnt) * 100,
                                        volume: parseFloat(ticker.volume24h),
                                        high: parseFloat(ticker.highPrice24h),
                                        low: parseFloat(ticker.lowPrice24h),
                                        timestamp: Date.now()
                                    };
                                    break;
                                }
                            }
                            
                            updatePriceTicker();
                            updatePortfolioValues();
                            updateLastUpdatedTime();
                        }
                    } catch (error) {
                        console.error('Error parsing WebSocket message:', error);
                    }
                };
                
                state.websocket.onerror = (error) => {
                    console.error('WebSocket error:', error);
                    document.getElementById('connectionStatus').innerHTML = `
                        <span class="status-indicator" style="background-color: var(--danger);"></span>
                        <span>Connection Error</span>
                    `;
                };
                
                state.websocket.onclose = () => {
                    console.log('WebSocket disconnected');
                    document.getElementById('connectionStatus').innerHTML = `
                        <span class="status-indicator" style="background-color: var(--warning);"></span>
                        <span>Reconnecting in 3s...</span>
                    `;
                    
                    setTimeout(connectWebSocket, 3000);
                };
                
            } catch (error) {
                console.error('Error connecting to WebSocket:', error);
                showToast('Connection Error', 'Failed to connect to Bybit', 'error');
            }
        }

        function updatePriceTicker() {
            const priceTicker = document.getElementById('priceTicker');
            priceTicker.innerHTML = '';
            
            state.selectedAssets.forEach(symbol => {
                const asset = BYBIT_ASSETS[symbol];
                const priceInfo = state.priceData[symbol];
                
                if (!asset) return;
                
                const priceItem = document.createElement('div');
                priceItem.className = 'price-item';
                
                let price = priceInfo ? priceInfo.price : 0;
                let change24h = priceInfo ? priceInfo.change24h : 0;
                
                const changeClass = change24h >= 0 ? 'positive' : 'negative';
                const changeIcon = change24h >= 0 ? 'fa-arrow-up' : 'fa-arrow-down';
                
                priceItem.innerHTML = `
                    <img src="${asset.logo}" alt="${asset.name}" class="crypto-logo">
                    <div class="crypto-info">
                        <div class="crypto-symbol">${symbol}</div>
                        <div class="crypto-name">${asset.name}</div>
                    </div>
                    <div class="price-info">
                        <div class="current-price">${price > 0 ? `$${formatNumber(price, price < 1 ? 6 : 2)}` : 'Loading...'}</div>
                        <div class="price-change ${changeClass}">
                            <i class="fas ${changeIcon}"></i>
                            ${priceInfo ? formatPercent(change24h, 2) : '0.00%'}
                        </div>
                    </div>
                `;
                
                priceTicker.appendChild(priceItem);
            });
        }

        function getCurrentPrice(assetSymbol) {
            return state.priceData[assetSymbol]?.price || 0;
        }

        // ==============================
        // PORTFOLIO CALCULATIONS
        // ==============================
        function calculatePortfolio() {
            let totalFees = D(0);
            let allTimeRealizedPL = D(0);
            let currentHoldings = {};
            
            const buyQueue = {};
            
            state.selectedAssets.forEach(symbol => {
                buyQueue[symbol] = [];
            });
            buyQueue['USDT'] = [];
            
            const sortedTxs = [...state.store.transactions].sort((a, b) => 
                new Date(a.date) - new Date(b.date)
            );
            
            sortedTxs.forEach(tx => {
                const asset = tx.asset;
                totalFees = totalFees.plus(tx.feeInUSDT);
                
                if (tx.type === 'BUY') {
                    if (!buyQueue[asset]) buyQueue[asset] = [];
                    buyQueue[asset].push({
                        amount: tx.amount,
                        price: tx.price,
                        date: tx.date
                    });
                    
                } else if (tx.type === 'SELL') {
                    let remainingSell = tx.amount;
                    let totalCostBasis = D(0);
                    
                    while (remainingSell.gt(0) && buyQueue[asset] && buyQueue[asset].length > 0) {
                        const oldestBuy = buyQueue[asset][0];
                        
                        if (oldestBuy.amount.lte(remainingSell)) {
                            totalCostBasis = totalCostBasis.plus(oldestBuy.amount.times(oldestBuy.price));
                            remainingSell = remainingSell.minus(oldestBuy.amount);
                            buyQueue[asset].shift();
                        } else {
                            totalCostBasis = totalCostBasis.plus(remainingSell.times(oldestBuy.price));
                            oldestBuy.amount = oldestBuy.amount.minus(remainingSell);
                            remainingSell = D(0);
                        }
                    }
                    
                    const sellValue = tx.amount.times(tx.price);
                    const pl = sellValue.minus(totalCostBasis);
                    allTimeRealizedPL = allTimeRealizedPL.plus(pl);
                    
                    tx.profitLoss = pl;
                }
            });
            
            Object.keys(buyQueue).forEach(asset => {
                let totalAmount = D(0);
                let totalValue = D(0);
                
                buyQueue[asset].forEach(buy => {
                    totalAmount = totalAmount.plus(buy.amount);
                    totalValue = totalValue.plus(buy.amount.times(buy.price));
                });
                
                if (totalAmount.gt(0)) {
                    const currentPrice = asset === 'USDT' ? D(1) : D(getCurrentPrice(asset) || 0);
                    const currentValue = totalAmount.times(currentPrice);
                    const avgPrice = totalAmount.gt(0) ? totalValue.div(totalAmount) : D(0);
                    const unrealizedPL = currentValue.minus(totalValue);
                    const plPercent = totalValue.gt(0) ? unrealizedPL.div(totalValue).times(100) : D(0);
                    
                    currentHoldings[asset] = {
                        amount: totalAmount,
                        avgPrice: avgPrice,
                        costBasis: totalValue,
                        currentValue: currentValue,
                        unrealizedPL: unrealizedPL,
                        plPercent: plPercent
                    };
                }
            });
            
            let totalPortfolioValue = D(0);
            Object.values(currentHoldings).forEach(h => {
                totalPortfolioValue = totalPortfolioValue.plus(h.currentValue);
            });
            
            updatePortfolioDisplay(totalPortfolioValue, allTimeRealizedPL, totalFees, currentHoldings);
            
            return {
                currentHoldings,
                totalPortfolioValue,
                allTimeRealizedPL,
                totalFees
            };
        }

        function updatePortfolioDisplay(totalPortfolioValue, allTimeRealizedPL, totalFees, currentHoldings) {
            document.getElementById('portfolioValue').textContent = formatCurrency(totalPortfolioValue, 2);
            document.getElementById('portfolioValue').className = `card-value ${totalPortfolioValue.gte(0) ? 'positive' : 'negative'}`;
            
            const activePeriodBtn = document.querySelector('.pl-period-btn.active');
            const plPeriod = activePeriodBtn ? activePeriodBtn.dataset.plPeriod : 'all';
            
            let displayPL = allTimeRealizedPL;
            let displayPLText = 'All time';
            
            if (plPeriod === 'month') {
                const oneMonthAgo = new Date();
                oneMonthAgo.setDate(oneMonthAgo.getDate() - 30);
                
                const monthTxs = state.store.transactions.filter(tx => 
                    new Date(tx.date) >= oneMonthAgo
                );
                
                displayPL = monthTxs.reduce((sum, tx) => sum.plus(tx.profitLoss), D(0));
                displayPLText = 'Last 30 days';
                
            } else if (plPeriod === 'cycle' && state.store.currentTrade.isActive) {
                displayPL = state.store.currentTrade.cycleRealizedPL;
                displayPLText = 'Current cycle';
            }
            
            document.getElementById('realizedPL').textContent = formatCurrency(displayPL, 2);
            document.getElementById('realizedPL').className = `card-value ${displayPL.gte(0) ? 'positive' : 'negative'}`;
            
            const tradeCapital = state.store.currentTrade.originalCapital;
            let plPercent = D(0);
            
            if (plPeriod === 'cycle' && tradeCapital.gt(0)) {
                plPercent = displayPL.div(tradeCapital).times(100);
            } else if (plPeriod === 'all' || plPeriod === 'month') {
                const referenceValue = totalPortfolioValue.minus(displayPL);
                plPercent = referenceValue.gt(0) ? displayPL.div(referenceValue).times(100) : D(0);
            }
            
            document.getElementById('realizedPLChange').innerHTML = `
                <i class="fas ${displayPL.gte(0) ? 'fa-arrow-up' : 'fa-arrow-down'}"></i>
                <span>${formatPercent(plPercent, 2)} ${displayPLText}</span>
            `;
            document.getElementById('realizedPLChange').className = `card-change ${displayPL.gte(0) ? 'positive' : 'negative'}`;
            
            document.getElementById('currentTradeCapital').textContent = formatCurrency(tradeCapital, 2);
            
            if (state.store.currentTrade.isActive && state.store.currentTrade.transactions.length > 0) {
                const currentTradePL = state.store.currentTrade.cycleRealizedPL;
                const currentTradePLPercent = tradeCapital.gt(0) ? 
                    currentTradePL.div(tradeCapital).times(100) : D(0);
                
                document.getElementById('capitalChange').innerHTML = `
                    <i class="fas ${currentTradePL.gte(0) ? 'fa-arrow-up' : 'fa-arrow-down'}"></i>
                    <span>${currentTradePL.gte(0) ? '+' : ''}${formatCurrency(currentTradePL, 2)} (${formatPercent(currentTradePLPercent, 2)})</span>
                `;
                document.getElementById('capitalChange').className = `card-change ${currentTradePL.gte(0) ? 'positive' : 'negative'}`;
            } else {
                document.getElementById('capitalChange').textContent = 'No active trade';
                document.getElementById('capitalChange').className = 'card-change';
            }
            
            document.getElementById('totalFees').textContent = formatCurrency(totalFees, 2);
            
            updateHoldingsTable(currentHoldings);
        }

        function updatePortfolioValues() {
            calculatePortfolio();
        }

        function updateHoldingsTable(holdings) {
            const tbody = document.getElementById('holdingsTableBody');
            
            if (Object.keys(holdings).length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 3rem; color: var(--text-muted);">
                            No holdings yet. Add transactions to see your portfolio.
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = '';
            
            Object.entries(holdings).forEach(([asset, data]) => {
                const currentPrice = asset === 'USDT' ? 1 : getCurrentPrice(asset) || 0;
                const assetInfo = BYBIT_ASSETS[asset];
                const row = document.createElement('tr');
                
                const plClass = data.unrealizedPL.gte(0) ? 'positive' : 'negative';
                const plPercentClass = data.plPercent.gte(0) ? 'positive' : 'negative';
                
                row.innerHTML = `
                    <td>
                        <div class="holding-asset">
                            <img src="${assetInfo?.logo || 'https://assets.coingecko.com/coins/images/1/large/bitcoin.png'}" alt="${asset}" class="crypto-logo" style="width: 24px; height: 24px;">
                            <div>
                                <div style="font-weight: 600;">${asset}</div>
                                <div style="font-size: 0.75rem; color: var(--text-muted);">${assetInfo?.name || asset}</div>
                            </div>
                        </div>
                    </td>
                    <td>${formatNumber(data.amount, 6)}</td>
                    <td>${formatCurrency(data.avgPrice, 2)}</td>
                    <td>${formatCurrency(currentPrice, 2)}</td>
                    <td>${formatCurrency(data.currentValue, 2)}</td>
                    <td class="${plClass}">${data.unrealizedPL.gte(0) ? '+' : ''}${formatCurrency(data.unrealizedPL, 2)}</td>
                    <td class="${plPercentClass}">${data.plPercent.gte(0) ? '+' : ''}${formatNumber(data.plPercent, 2)}%</td>
                `;
                
                tbody.appendChild(row);
            });
        }

        // ==============================
        // TRADE CYCLE MANAGEMENT
        // ==============================
        function startNewTrade() {
            state.store.currentTrade = {
                originalCapital: D(0),
                cycleRealizedPL: D(0),
                startTime: new Date().toISOString(),
                transactions: [],
                isActive: true
            };
            
            startCycleTimer();
            saveStore();
            updateTradeStatus();
            showToast('Trade Started', 'New trade cycle started successfully', 'success');
        }

        function completeTrade() {
            if (!state.store.currentTrade.isActive) {
                showToast('Error', 'No active trade to complete', 'error');
                return;
            }
            
            const tradeMetrics = calculateCurrentTradeCyclePL();
            state.store.currentTrade.cycleRealizedPL = tradeMetrics.realizedPL;
            
            const tradeCycle = {
                id: generateId('cycle'),
                startTime: state.store.currentTrade.startTime,
                endTime: new Date().toISOString(),
                originalCapital: state.store.currentTrade.originalCapital,
                realizedPL: state.store.currentTrade.cycleRealizedPL,
                totalFees: tradeMetrics.totalFees,
                transactionCount: state.store.currentTrade.transactions.length
            };
            
            state.store.tradeCycles.unshift(tradeCycle);
            stopCycleTimer();
            
            state.store.currentTrade = {
                originalCapital: D(0),
                cycleRealizedPL: D(0),
                startTime: null,
                transactions: [],
                isActive: false
            };
            
            saveStore();
            updateTradeStatus();
            updateTradeCyclesTable();
            showToast('Trade Completed', 'Trade cycle completed successfully', 'success');
        }

        function calculateCurrentTradeCyclePL() {
            let realizedPL = D(0);
            let totalFees = D(0);
            
            const currentCycleTxs = state.store.transactions.filter(tx => 
                state.store.currentTrade.transactions.includes(tx.id)
            ).sort((a, b) => new Date(a.date) - new Date(b.date));
            
            const buyQueue = {};
            
            currentCycleTxs.forEach(tx => {
                totalFees = totalFees.plus(tx.feeInUSDT);
                
                if (tx.type === 'BUY') {
                    if (!buyQueue[tx.asset]) buyQueue[tx.asset] = [];
                    buyQueue[tx.asset].push({
                        amount: tx.amount,
                        price: tx.price
                    });
                    
                } else if (tx.type === 'SELL') {
                    let remainingSell = tx.amount;
                    let totalCostBasis = D(0);
                    
                    while (remainingSell.gt(0) && buyQueue[tx.asset] && buyQueue[tx.asset].length > 0) {
                        const oldestBuy = buyQueue[tx.asset][0];
                        
                        if (oldestBuy.amount.lte(remainingSell)) {
                            totalCostBasis = totalCostBasis.plus(oldestBuy.amount.times(oldestBuy.price));
                            remainingSell = remainingSell.minus(oldestBuy.amount);
                            buyQueue[tx.asset].shift();
                        } else {
                            totalCostBasis = totalCostBasis.plus(remainingSell.times(oldestBuy.price));
                            oldestBuy.amount = oldestBuy.amount.minus(remainingSell);
                            remainingSell = D(0);
                        }
                    }
                    
                    const sellValue = tx.amount.times(tx.price);
                    const pl = sellValue.minus(totalCostBasis);
                    realizedPL = realizedPL.plus(pl);
                }
            });
            
            return { realizedPL, totalFees };
        }

        function startCycleTimer() {
            stopCycleTimer();
            state.cycleTimerInterval = setInterval(() => {
                updateTradeStatus();
            }, 1000);
        }

        function stopCycleTimer() {
            if (state.cycleTimerInterval) {
                clearInterval(state.cycleTimerInterval);
                state.cycleTimerInterval = null;
            }
        }

        function updateTradeStatus() {
            const badge = document.getElementById('tradeStatusBadge');
            const duration = document.getElementById('tradeDuration');
            const cyclePL = document.getElementById('cycleRealizedPL');
            const cycleTransactions = document.getElementById('cycleTransactions');
            const cycleFees = document.getElementById('cycleFees');
            const startBtn = document.getElementById('startTradeBtn');
            const completeBtn = document.getElementById('completeTradeBtn');
            
            if (state.store.currentTrade.isActive) {
                badge.innerHTML = '<i class="fas fa-circle"></i><span>Active</span>';
                badge.style.backgroundColor = 'rgba(16, 185, 129, 0.1)';
                badge.style.color = 'var(--success)';
                
                if (state.store.currentTrade.startTime) {
                    const start = new Date(state.store.currentTrade.startTime);
                    const now = new Date();
                    const diffMs = now - start;
                    
                    duration.textContent = formatTime(diffMs);
                }
                
                const cycleMetrics = calculateCurrentTradeCyclePL();
                cyclePL.textContent = formatCurrency(cycleMetrics.realizedPL, 2);
                cyclePL.className = `status-value ${cycleMetrics.realizedPL.gte(0) ? 'positive' : 'negative'}`;
                cycleTransactions.textContent = state.store.currentTrade.transactions.length;
                cycleFees.textContent = formatCurrency(cycleMetrics.totalFees, 2);
                
                startBtn.style.display = 'none';
                completeBtn.style.display = 'block';
                
            } else {
                badge.innerHTML = '<i class="fas fa-circle"></i><span>No Active Trade</span>';
                badge.style.backgroundColor = 'rgba(148, 163, 184, 0.1)';
                badge.style.color = 'var(--text-secondary)';
                
                duration.textContent = '00:00:00';
                cyclePL.textContent = '$0.00';
                cyclePL.className = 'status-value';
                cycleTransactions.textContent = '0';
                cycleFees.textContent = '$0.00';
                
                startBtn.style.display = 'block';
                completeBtn.style.display = 'none';
            }
        }

        function updateTradeCyclesTable() {
            const tbody = document.getElementById('tradeCyclesTableBody');
            
            if (state.store.tradeCycles.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 3rem; color: var(--text-muted);">
                            No completed trade cycles yet.
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = '';
            
            state.store.tradeCycles.slice(0, 10).forEach(cycle => {
                const row = document.createElement('tr');
                
                const startDate = new Date(cycle.startTime).toLocaleDateString();
                const endDate = new Date(cycle.endTime).toLocaleDateString();
                const plPercent = cycle.originalCapital.gt(0) ? 
                    cycle.realizedPL.div(cycle.originalCapital).times(100) : D(0);
                
                const plClass = cycle.realizedPL.gte(0) ? 'positive' : 'negative';
                const plPercentClass = plPercent.gte(0) ? 'positive' : 'negative';
                
                row.innerHTML = `
                    <td>${startDate}</td>
                    <td>${endDate}</td>
                    <td>${formatCurrency(cycle.originalCapital, 2)}</td>
                    <td class="${plClass}">${cycle.realizedPL.gte(0) ? '+' : ''}${formatCurrency(cycle.realizedPL, 2)}</td>
                    <td class="${plPercentClass}">${plPercent.gte(0) ? '+' : ''}${formatNumber(plPercent, 2)}%</td>
                    <td>${formatCurrency(cycle.totalFees, 2)}</td>
                    <td>${cycle.transactionCount}</td>
                `;
                
                tbody.appendChild(row);
            });
        }

        // ==============================
        // TRANSACTION MANAGEMENT
        // ==============================
        function saveTransaction() {
            const type = document.getElementById('txType').value;
            const asset = document.getElementById('txAsset').value;
            const amount = D(document.getElementById('txAmount').value || 0);
            const price = D(document.getElementById('txPrice').value || 0);
            const fee = D(document.getElementById('txFee').value || 0);
            const feeCurrency = document.getElementById('txFeeCurrency').value;
            const date = document.getElementById('txDate').value || new Date().toISOString().slice(0, 16);
            
            if (amount.lte(0) || price.lte(0)) {
                showToast('Error', 'Please enter valid amount and price', 'error');
                return;
            }
            
            const orderValue = amount.times(price);
            let feeInUSDT = fee;
            
            if (feeCurrency !== 'USDT') {
                const feeAssetPrice = getCurrentPrice(feeCurrency) || 0;
                feeInUSDT = fee.times(D(feeAssetPrice));
            }
            
            if (!state.store.currentTrade.isActive && state.store.transactions.length === 0) {
                startNewTrade();
            }
            
            const transaction = {
                id: generateId('tx'),
                date,
                type,
                asset,
                amount,
                price,
                orderValue,
                fee,
                feeCurrency,
                feeInUSDT,
                profitLoss: D(0),
                tradeCycleId: state.store.currentTrade.isActive ? 'current' : null
            };
            
            state.store.transactions.push(transaction);
            
            if (state.store.currentTrade.isActive) {
                state.store.currentTrade.transactions.push(transaction.id);
                
                if (type === 'BUY') {
                    state.store.currentTrade.originalCapital = state.store.currentTrade.originalCapital.plus(orderValue);
                }
            }
            
            saveStore();
            hideTransactionForm();
            renderTransactions();
            calculatePortfolio();
            updateTradeStatus();
            showToast('Success', 'Transaction added successfully', 'success');
        }

        function deleteTransaction(id) {
            if (!confirm('Are you sure you want to delete this transaction?')) return;
            
            if (state.store.currentTrade.isActive) {
                const txIndex = state.store.currentTrade.transactions.indexOf(id);
                if (txIndex > -1) {
                    state.store.currentTrade.transactions.splice(txIndex, 1);
                    
                    const tx = state.store.transactions.find(t => t.id === id);
                    if (tx && tx.type === 'BUY') {
                        state.store.currentTrade.originalCapital = state.store.currentTrade.originalCapital.minus(tx.orderValue);
                    }
                }
            }
            
            state.store.transactions = state.store.transactions.filter(tx => tx.id !== id);
            saveStore();
            renderTransactions();
            calculatePortfolio();
            updateTradeStatus();
            showToast('Success', 'Transaction deleted', 'success');
        }

        function renderTransactions() {
            const tbody = document.getElementById('transactionsTableBody');
            
            if (state.store.transactions.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="10" style="text-align: center; padding: 3rem; color: var(--text-muted);">
                            No transactions yet. Add your first transaction to begin tracking.
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = '';
            
            const sortedTxs = [...state.store.transactions].sort((a, b) => 
                new Date(b.date) - new Date(a.date)
            );
            
            sortedTxs.forEach(tx => {
                const row = document.createElement('tr');
                
                const date = new Date(tx.date);
                const formattedDate = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                
                let tradeCycleDisplay = '-';
                if (tx.tradeCycleId === 'current' && state.store.currentTrade.isActive) {
                    tradeCycleDisplay = 'Current';
                }
                
                const plClass = tx.profitLoss.gte(0) ? 'positive' : 'negative';
                
                row.innerHTML = `
                    <td>${formattedDate}</td>
                    <td>${tx.type}</td>
                    <td>${tx.asset}</td>
                    <td>${formatNumber(tx.amount, 6)}</td>
                    <td>${formatCurrency(tx.price, 2)}</td>
                    <td>${formatCurrency(tx.orderValue, 2)}</td>
                    <td>${formatNumber(tx.fee, 6)} ${tx.feeCurrency}</td>
                    <td class="${plClass}">${tx.profitLoss.gte(0) ? '+' : ''}${formatCurrency(tx.profitLoss, 2)}</td>
                    <td>${tradeCycleDisplay}</td>
                    <td>
                        <button class="btn btn-danger btn-sm" onclick="deleteTransaction('${tx.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }

        // ==============================
        // TRADE PLANNER
        // ==============================
        function calculateTrade() {
            const asset = document.getElementById('plannerAsset').value;
            const entryPrice = D(document.getElementById('entryPrice').value || 0);
            const amount = D(document.getElementById('amount').value || 0);
            const targetProfit = D(document.getElementById('targetProfit').value || 0);
            const maxCapitalLoss = D(document.getElementById('maxCapitalLoss').value || 0);
            const isTrailingMode = document.querySelector('[data-mode="trailing"]').classList.contains('active');
            
            if (entryPrice.lte(0) || amount.lte(0) || targetProfit.lte(0) || maxCapitalLoss.lte(0)) {
                showToast('Error', 'Please enter valid values for all fields', 'error');
                return;
            }
            
            const capital = entryPrice.times(amount);
            
            if (isTrailingMode) {
                const trailingDistance = D(document.getElementById('trailingDistance').value || 0);
                
                if (trailingDistance.lte(0)) {
                    showToast('Error', 'Please enter a valid trailing distance', 'error');
                    return;
                }
                
                const tpPrice = entryPrice.plus(targetProfit.div(amount));
                const slPrice = entryPrice.minus(maxCapitalLoss.div(amount));
                const activationPrice = entryPrice.plus(trailingDistance.div(amount));
                const trailingStopPrice = activationPrice.minus(trailingDistance.div(amount));
                
                const trailingProfit = trailingDistance;
                const trailingLoss = maxCapitalLoss;
                const trailingCapitalSL = capital.minus(trailingLoss);
                const securedProfit = D(0);
                
                const trailingROI = trailingProfit.div(capital).times(100);
                const trailingRR = trailingProfit.div(trailingLoss);
                
                document.getElementById('resultsHeader').textContent = 'Trailing Stop Results';
                document.getElementById('trailingResults').style.display = 'block';
                document.getElementById('tpSlResults').style.display = 'none';
                
                document.getElementById('trailingCapital').textContent = formatCurrency(capital, 2);
                document.getElementById('trailingTP').textContent = formatCurrency(tpPrice, 2);
                document.getElementById('trailingSL').textContent = formatCurrency(slPrice, 2);
                document.getElementById('activationPrice').textContent = formatCurrency(activationPrice, 2);
                document.getElementById('trailingStopPrice').textContent = formatCurrency(trailingStopPrice, 2);
                document.getElementById('trailingProfit').textContent = `+${formatCurrency(trailingProfit, 2)}`;
                document.getElementById('trailingLoss').textContent = `-${formatCurrency(trailingLoss, 2)}`;
                document.getElementById('trailingCapitalSL').textContent = formatCurrency(trailingCapitalSL, 2);
                document.getElementById('securedProfit').textContent = `+${formatCurrency(securedProfit, 2)}`;
                document.getElementById('trailingROI').textContent = `${formatNumber(trailingROI, 2)}%`;
                document.getElementById('trailingRR').textContent = `1:${formatNumber(trailingRR, 2)}`;
                
            } else {
                const tpPrice = entryPrice.plus(targetProfit.div(amount));
                const slPrice = entryPrice.minus(maxCapitalLoss.div(amount));
                
                const potentialProfit = targetProfit;
                const potentialLoss = maxCapitalLoss;
                const capitalIfSL = capital.minus(potentialLoss);
                
                const roi = potentialProfit.div(capital).times(100);
                const rrRatio = potentialProfit.div(potentialLoss);
                
                document.getElementById('resultsHeader').textContent = 'TP/SL Results';
                document.getElementById('tpSlResults').style.display = 'block';
                document.getElementById('trailingResults').style.display = 'none';
                
                document.getElementById('capitalValue').textContent = formatCurrency(capital, 2);
                document.getElementById('tpPrice').textContent = formatCurrency(tpPrice, 2);
                document.getElementById('slPrice').textContent = formatCurrency(slPrice, 2);
                document.getElementById('potentialProfit').textContent = `+${formatCurrency(potentialProfit, 2)}`;
                document.getElementById('potentialLoss').textContent = `-${formatCurrency(potentialLoss, 2)}`;
                document.getElementById('capitalIfSL').textContent = formatCurrency(capitalIfSL, 2);
                document.getElementById('roiValue').textContent = `${formatNumber(roi, 2)}%`;
                document.getElementById('rrRatio').textContent = `1:${formatNumber(rrRatio, 2)}`;
            }
        }

        // ==============================
        // UI MANAGEMENT
        // ==============================
        function showSection(sectionId) {
            document.querySelectorAll('.content-section').forEach(section => {
                section.style.display = 'none';
            });
            
            const section = document.getElementById(sectionId);
            if (section) {
                section.style.display = 'block';
            }
            
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            const activeNav = document.querySelector(`.nav-item[data-section="${sectionId}"]`);
            if (activeNav) {
                activeNav.classList.add('active');
            }
        }

        function showTransactionForm() {
            document.getElementById('transactionForm').style.display = 'grid';
            document.getElementById('noFormMessage').style.display = 'none';
            document.getElementById('txDate').value = new Date().toISOString().slice(0, 16);
        }

        function hideTransactionForm() {
            document.getElementById('transactionForm').style.display = 'none';
            document.getElementById('noFormMessage').style.display = 'block';
            
            document.getElementById('txAmount').value = '';
            document.getElementById('txPrice').value = '';
            document.getElementById('txFee').value = '0';
        }

        function openAssetManagementModal() {
            document.getElementById('assetManagementModal').classList.add('active');
            loadAssetManagement();
        }

        function closeAssetManagementModal() {
            document.getElementById('assetManagementModal').classList.remove('active');
        }

        function updateTabletMode() {
            if (state.store.settings.tabletMode) {
                document.body.classList.add('tablet-mode');
            } else {
                document.body.classList.remove('tablet-mode');
            }
        }

        //  FIXED: Setup auto-refresh interval
        function setupAutoRefresh() {
            if (state.autoRefreshInterval) {
                clearInterval(state.autoRefreshInterval);
                state.autoRefreshInterval = null;
            }
            
            if (state.store.settings.autoRefresh) {
                state.autoRefreshInterval = setInterval(() => {
                    updatePortfolioValues();
                    updateLastUpdatedTime();
                }, 3000);
            }
        }

        // ==============================
        //  FIXED: EVENT LISTENERS
        // ==============================
        function setupEventListeners() {
            document.getElementById('menuToggle').addEventListener('click', () => {
                document.getElementById('sidebar').classList.add('active');
                document.getElementById('sidebarOverlay').classList.add('active');
            });
            
            document.getElementById('sidebarOverlay').addEventListener('click', () => {
                document.getElementById('sidebar').classList.remove('active');
                document.getElementById('sidebarOverlay').classList.remove('active');
            });
            
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    const sectionId = item.dataset.section;
                    showSection(sectionId);
                    
                    document.getElementById('sidebar').classList.remove('active');
                    document.getElementById('sidebarOverlay').classList.remove('active');
                });
            });
            
            document.getElementById('manageAssetsBtn').addEventListener('click', openAssetManagementModal);
            document.getElementById('closeAssetModal').addEventListener('click', closeAssetManagementModal);
            
            document.getElementById('startTradeBtn').addEventListener('click', startNewTrade);
            document.getElementById('completeTradeBtn').addEventListener('click', completeTrade);
            
            document.getElementById('refreshPortfolio').addEventListener('click', () => {
                updatePortfolioValues();
                showToast('Refreshed', 'Portfolio updated with latest prices', 'success');
            });
            
            document.getElementById('refreshHoldings').addEventListener('click', () => {
                calculatePortfolio();
                showToast('Refreshed', 'Holdings updated', 'success');
            });
            
            document.querySelectorAll('.pl-period-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.pl-period-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    updatePortfolioValues();
                });
            });
            
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    
                    const mode = btn.dataset.mode;
                    const trailingInput = document.getElementById('trailingInput');
                    trailingInput.style.display = mode === 'trailing' ? 'block' : 'none';
                });
            });
            
            document.getElementById('currentPriceBtn').addEventListener('click', () => {
                const asset = document.getElementById('plannerAsset').value;
                const currentPrice = getCurrentPrice(asset);
                
                if (currentPrice > 0) {
                    document.getElementById('entryPrice').value = currentPrice;
                    showToast('Price Updated', `Current ${asset} price set to $${formatNumber(currentPrice, 2)}`, 'success');
                } else {
                    showToast('Error', `Could not fetch current price for ${asset}`, 'error');
                }
            });
            
            document.getElementById('calculateTradeBtn').addEventListener('click', calculateTrade);
            
            document.getElementById('plannerAsset').addEventListener('change', function() {
                const currentPrice = getCurrentPrice(this.value);
                if (currentPrice > 0) {
                    document.getElementById('entryPrice').value = currentPrice;
                }
            });
            
            document.getElementById('addTransactionBtn').addEventListener('click', showTransactionForm);
            document.getElementById('showTransactionFormBtn').addEventListener('click', showTransactionForm);
            document.getElementById('saveTransactionBtn').addEventListener('click', saveTransaction);
            document.getElementById('cancelTransactionBtn').addEventListener('click', hideTransactionForm);
            
            document.getElementById('exportCsvBtn').addEventListener('click', exportToCsv);
            document.getElementById('exportJsonBtn').addEventListener('click', exportToJson);
            document.getElementById('importBtn').addEventListener('click', () => {
                document.getElementById('importFileInput').click();
            });
            
            document.getElementById('importFileInput').addEventListener('change', importFromJson);
            
            document.getElementById('resetDataBtn').addEventListener('click', clearAllData);
            
            //  FIXED: Settings toggles
            document.getElementById('tabletModeToggle').addEventListener('change', function() {
                state.store.settings.tabletMode = this.checked;
                saveStore();
                updateTabletMode();
                showToast('Settings Updated', `Tablet mode ${this.checked ? 'enabled' : 'disabled'}`, 'success');
            });
            
            document.getElementById('autoRefreshToggle').addEventListener('change', function() {
                state.store.settings.autoRefresh = this.checked;
                saveStore();
                setupAutoRefresh();
                showToast('Settings Updated', `Auto-refresh ${this.checked ? 'enabled' : 'disabled'}`, 'success');
            });
            
            document.getElementById('notificationsToggle').addEventListener('change', function() {
                state.store.settings.notifications = this.checked;
                saveStore();
                showToast('Settings Updated', `Notifications ${this.checked ? 'enabled' : 'disabled'}`, 'success');
            });
            
            document.getElementById('backupDataBtn').addEventListener('click', exportToJson);
            
            //  FIXED: Clear Cache button
            document.getElementById('clearCacheBtn').addEventListener('click', () => {
                if (confirm('Clear application cache? This will not delete your transaction data.')) {
                    clearCache();
                }
            });
            
            //  FIXED: Clear All Data button
            document.getElementById('clearAllDataBtn').addEventListener('click', () => {
                clearAllData();
            });
            
            //  FIXED: API Credentials with clear purpose
            document.getElementById('saveApiCredentialsBtn').addEventListener('click', () => {
                state.store.settings.apiKey = document.getElementById('apiKeyInput').value;
                state.store.settings.apiSecret = document.getElementById('apiSecretInput').value;
                saveStore();
                showToast('API Credentials', 'Saved for future private API features', 'success');
            });
        }

        // ==============================
        // DATA EXPORT/IMPORT
        // ==============================
        function exportToCsv() {
            if (state.store.transactions.length === 0) {
                showToast('Error', 'No transactions to export', 'error');
                return;
            }
            
            const headers = ['Date', 'Type', 'Asset', 'Amount', 'Price', 'Value', 'Fee', 'Fee Currency', 'P/L', 'Trade Cycle'];
            const csvRows = [headers.join(',')];
            
            state.store.transactions.forEach(tx => {
                const date = new Date(tx.date).toLocaleString();
                const row = [
                    `"${date}"`,
                    tx.type,
                    tx.asset,
                    tx.amount.toString(),
                    tx.price.toString(),
                    tx.orderValue.toString(),
                    tx.fee.toString(),
                    tx.feeCurrency,
                    tx.profitLoss.toString(),
                    tx.tradeCycleId || ''
                ];
                csvRows.push(row.join(','));
            });
            
            const csvContent = csvRows.join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `crypto-suite-transactions-${new Date().toISOString().slice(0, 10)}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            
            showToast('Export Complete', 'Transactions exported as CSV', 'success');
        }

        function exportToJson() {
            const dataStr = JSON.stringify(state.store, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `crypto-suite-backup-${new Date().toISOString().slice(0, 10)}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            showToast('Backup Complete', 'All data exported as JSON', 'success');
        }

        function importFromJson(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    if (!importedData.transactions || !Array.isArray(importedData.transactions)) {
                        throw new Error('Invalid data format');
                    }
                    
                    importedData.transactions = importedData.transactions.map(tx => ({
                        ...tx,
                        amount: D(tx.amount),
                        price: D(tx.price),
                        orderValue: D(tx.orderValue),
                        fee: D(tx.fee),
                        feeInUSDT: D(tx.feeInUSDT || 0),
                        profitLoss: D(tx.profitLoss || 0)
                    }));
                    
                    if (importedData.tradeCycles) {
                        importedData.tradeCycles = importedData.tradeCycles.map(cycle => ({
                            ...cycle,
                            originalCapital: D(cycle.originalCapital),
                            realizedPL: D(cycle.realizedPL),
                            totalFees: D(cycle.totalFees)
                        }));
                    }
                    
                    if (importedData.currentTrade) {
                        importedData.currentTrade = {
                            ...importedData.currentTrade,
                            originalCapital: D(importedData.currentTrade.originalCapital || 0),
                            cycleRealizedPL: D(importedData.currentTrade.cycleRealizedPL || 0)
                        };
                    }
                    
                    importedData.settings = {
                        ...state.store.settings,
                        ...importedData.settings
                    };
                    
                    state.store = importedData;
                    saveStore();
                    
                    renderTransactions();
                    calculatePortfolio();
                    updateTradeStatus();
                    updateTradeCyclesTable();
                    updateAssetSelects();
                    
                    showToast('Import Complete', 'Data imported successfully', 'success');
                    
                } catch (error) {
                    console.error('Import error:', error);
                    showToast('Import Error', 'Failed to import data. Invalid file format.', 'error');
                }
            };
            reader.readAsText(file);
            
            event.target.value = '';
        }

        // ==============================
        // INITIALIZATION
        // ==============================
        async function init() {
            loadStore();
            setupEventListeners();
            updateAssetSelects();
            renderTransactions();
            calculatePortfolio();
            updateTradeStatus();
            updateTradeCyclesTable();
            updateStorageInfo();
            
            const now = new Date();
            const timezoneOffset = now.getTimezoneOffset() * 60000;
            const localISOTime = new Date(now - timezoneOffset).toISOString().slice(0, 16);
            document.getElementById('txDate').value = localISOTime;
            
            const initialAsset = document.getElementById('plannerAsset').value;
            const initialPrice = getCurrentPrice(initialAsset);
            if (initialPrice > 0) {
                document.getElementById('entryPrice').value = initialPrice;
            }
            
            document.getElementById('tabletModeToggle').checked = state.store.settings.tabletMode;
            updateTabletMode();
            
            document.getElementById('autoRefreshToggle').checked = state.store.settings.autoRefresh;
            document.getElementById('notificationsToggle').checked = state.store.settings.notifications;
            
            document.getElementById('apiKeyInput').value = state.store.settings.apiKey;
            document.getElementById('apiSecretInput').value = state.store.settings.apiSecret;
            
            connectWebSocket();
            setupAutoRefresh();
            
            if (state.store.currentTrade.isActive) {
                startCycleTimer();
            }
            
            console.log('Crypto Suite Final Version Initialized');
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
